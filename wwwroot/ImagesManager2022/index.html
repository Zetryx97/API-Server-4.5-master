<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div id="message-about">Une création de Gabriel Lessard et Nathanael Kolodenchuk.
        Session Automne 2022 - Collège Lionel-Groulx
    </div>

    <form id="creation-account-form">
        <input type="hidden" id="Id_User" value="0">
        <input type="hidden" id="create_input" value="0">
        <input type="hidden" id="AvatarGUID_input" value="">
        <label for="username_input">Nom d'usager</label>
        <input type="text" id="username_input" class="form-control" required>

        <label for="email_input">Courriel</label>
        <input type="email" id="email_input" class="form-control" required>


        <label for="pwdUser">Mot de passe</label>
        <input type="password" id="pwdUser" class="form-control MatchedPassword" matchedPasswordId="pwdUserConfirm" />

        <label for="pwdUserConfirm">Confirmation</label>
        <input type="password" id="pwdUserConfirm" class="form-control" />


        <label for="avatar">Avatar</label>
        <div id='avatar' class='ImageUploader' defaultImage='images/No_Avatar.png' waitingImage='images/writing.gif'>
        </div>
        <div class="note">Cliquez-Déposez votre avatar</div>
    </form>

    <div id="loginDialog">
        <form id="loginForm">
            <label for="email-login">Courriel</label><input type="email" id="email-login" required class="form-control">
            <label for="pwd-login">Mot de passe</label> <input type="password" class="form-control" id="pwd-login"
                required>
            <input type="checkbox" id="checked-user"> <label for="remember-user" value="0">Se souvenir de moi</label>
        </form>
    </div>

    <div id="verifiedEmailDialog">
        Consulter votre boîte de courriel pour connaître votre code
        de vérification et inscrivez-le ci-dessous
        <form id="verifiedCodeForm">
            <label for="verifyCodeInput">Code de vérification</label><input type="text" id="verifyCodeInput"
                class="form-control">
        </form>
    </div>


    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout">
                <img id="icon-site" src="images/camera.png" alt="" data-toggle="tooltip" class="favicon"
                    title="Gestionnaire d'images">
                <div>
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                    <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image" 
                    data-toggle="tooltip"></span> 

                    <span class="cmd fa fa-arrow-down-wide-short" id="triAscendant"
                        title="Trier les images en ordre décroissant" data-toggle="tooltip"
                        onclick="changeOrder()"></span>
                </div>


            </div>
            <div class="svg-wrapper">

                
                <span title="Vérfier mon compte" data-toggle="tooltip" id="verifyUserNotDone" class="cmd fa fa-square-check"></span>
                <img src="" class="avatar" id="avatarUserConnected">
                <span id="showUserInfo"></span>

                <span class="cmd fa fa-arrow-right-from-bracket" id="logOutCmd" title="Sign out"
                    data-toggle="tooltip"></span>

                <span class="cmd fa fa-address-card" id="editProfilCmd" title="Votre profil"
                    data-toggle="tooltip"></span>

                <span class="cmd fa fa-arrow-right-to-bracket" id="logInCmd" title="Login" data-toggle="tooltip"></span>

                <span class="cmd fa fa-user-plus" id="createAccountCmd" title="Create account"
                    data-toggle="tooltip"></span>


            </div>

        </div>
        <div class="searchBar">
            <select name="filters" id="filterList" class="searchParameters">
                <option value="">Tous les usagers</option>
            </select>

            <input type="text" placeholder="Recherche par mots-clés" class="searchParameters" id="imageSearchBar"
                value=""></input>

            <span class="cmd fa fa-magnifying-glass" id="searchImageCmd" title="Rechercher un image"
                data-toggle="tooltip" onclick="searchImage()">
            </span>
        </div>

        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
        </div>
        <div>
            <div id="imageDlg">
                <form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez une image</div>
                </form>
            </div>

            <div id="imageDetailsDlg">
                <!--<form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez une image</div>
                </form>-->
            </div>

            <div id="confirmDeleteDlg">
                <span id="confirmationMessage"></span>
            </div>
            <div id="errorDlg">
                <span id="errorMessage"></span>
            </div>

            <div id="deleteUserDialog">Voulez vous vraiment effacer votre compte ?</div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/customValidation.js"></script>
    <script src="js/imageUploader.js"></script>
    <script src="js/api.js"></script>
    <script src="js/date.js"></script>
    <script defer>
        const periodicRefreshPeriod = 15;
        let holdCheckETag = false;
        let currentETag = "";
        let createMode = true;
        let searchCategory = "";
        let searchTitle = "";
        let hideSearchBar = true;
        let imageIdToDelete = 0; // used by confirmDeleteDlg
        let selectedCategory = "";
        let imagesCount = 50;
        let appendCount = 3;
        let previousScrollPosition = 0;
        let appendMode = false;
        let isSignedIn = false;
        let imgUserId = sessionStorage.getItem('imgUserId');
        let imgMotsCles = sessionStorage.getItem('imgMotsCles');
        let UserArray = [];
        let userConnected = JSON.parse(sessionStorage.getItem("access_token"));
        let userData = JSON.parse(sessionStorage.getItem("user"));
        let orderBy = sessionStorage.getItem("orderBy");




        //window.localStorage.clear();
        $("#avatarUserConnected").hide();
        $("#logOutCmd").hide();
        $("#editProfilCmd").hide();
        $("#verifyUserNotDone").hide();
        if(userData != null)
        {
            checkUserConnected(userData);
        }
        
        init_UI();
        HEAD(checkETag, error);
        setInterval(() => {
            HEAD(checkETag, error)
        }, periodicRefreshPeriod * 1000);

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //---NAT---//   

        toggleUserConnectionIcon();


        $("#imageDetailsDlg").dialog({        
                title: "...",
                autoOpen: false,
                modal: true,
                show: {
                    effect: 'fade',
                    speed: 400
                },
                hide: {
                    effect: 'fade',
                    speed: 400
                },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: {
                    my: "top",
                    at: "top",
                    of: window
                },
                buttons: [{
                    id: "imageDetailsDlgOkBtn",
                    text: "Title will be changed dynamically",
                    click: function () {
                        let image = imageFromForm();
                        if (image) {
                            if (createMode) {
                                POST(image, getImagesList, error);
                                $(".scrollContainer").scrollTop(0);
                            } else
                                PUT(image, getImagesList, error);
                            resetimageForm();
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }
            ]
        });

        function toggleUserConnectionIcon() {
            if (!isSignedIn) {
                $("#ConnectionIcons").append($(
                    `<span class="cmd fa fa-arrow-right-to-bracket" id="logInCmd" title="Login" 
                            data-toggle="tooltip"></span>
                            <span class="cmd fa fa-user-plus" id="createAccountCmd" title="Create account" 
                            data-toggle="tooltip"></span>`
                ))
            } else {
                $("#ConnectionIcons").append($(
                    `<span class="cmd fa fa-arrow-right-from-bracket" id="logOutCmd" title="Sign out" 
                            data-toggle="tooltip"></span>`
                ));
            }
        }
        let imageUsersList = [];

        function searchImage() {
            sessionStorage.setItem("imgMotsCles", document.getElementById("imageSearchBar").value);
            sessionStorage.setItem("imgUserId", $('#filterList').val());
            location.reload();
        }

        function changeOrder() {
            if (orderBy != "asc")
                sessionStorage.setItem("orderBy", "asc")
            else
                sessionStorage.setItem("orderBy", "desc")
            location.reload();
        }



        function initFilterList(images, ETag) {
            images.forEach(image => {
                if (image.UserId != null) {
                    if (!imageUsersList.includes(image.UserId)) {
                        if (userData != null && image.UserId == userData.Id) {
                            $("#filterList").append($(
                                `<option value="` + image.UserId + `">Mes images</option>`
                            ));
                        } else {
                            GET_USER_LIST(image.UserId, addUserToFilters, error)
                        }
                        imageUsersList.push(image.UserId);
                    }
                }
            });

            function addUserToFilters(user, ETag) {
                if (user != null) {
                    if (!UserArray.includes(user)) {
                        UserArray.push(user)
                    }
                    $("#filterList").append($(
                        `<option value="` + user.Id + `">` + user.Name + `</option>`
                    ));
                }
            }

        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        function checkETag(ETag) {
            if (!holdCheckETag && ETag != currentETag) {
                currentETag = ETag;
                getImagesList();
            }
        }

        function getImagesList(refresh = true) {
            appendMode = !refresh;

            function prepareQueryString() {
                //let keywords = "Caribou"; 
                if (appendMode) {
                    queryString =
                        `?sort=Date,${orderBy}&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}&UserId=` +
                        imgUserId;
                    imagesCount += appendCount;
                } else {
                    queryString = `?sort=Date,${orderBy}&offset=${0}&limit=${imagesCount}&UserId=` + imgUserId;
                }
                if (imgMotsCles != null) {
                    queryString += "&keywords=" + imgMotsCles;
                }

                return queryString;
            }
            GET_ALL(initFilterList, error)
            GET_ALL(refreshimagesList, error, prepareQueryString())
        }

        function refreshimagesList(images, ETag) {
            document.getElementById("imageSearchBar").value = imgMotsCles;
            $('#filterList').val(imgUserId);

            function insertIntoImageList(image) {
                GET_USER_LIST(image.UserId, showUserPicture, error)
                $("#imagesList").append(
                    $(` 
                                <div class='imageLayout' ">
                                    <div class='imageHeader' id="${image.Id}">
                                        <div class="imageTitle" id=${image.Id}>${image.Title}</div>
                                    </div>
                                    
                                        <div    class='image' imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip"
                                                style="background-image:url('${image.ThumbnailURL}')">
                                                <img class="avatar" id="img${image.Id}"></img> 
                                        </div>
                                    </a>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                );
                if (userConnected != null && image.UserId == userConnected.UserId)
                    $(`#${image.Id}`).append($(`                    
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                `));

                function showUserPicture(user, ETag) {
                    if (user.AvatarURL == "") {
                        $(`#img${image.Id}`).attr("src", "images/No_Avatar.png");
                    } else {
                        $(`#img${image.Id}`).attr("src", user.AvatarURL);
                    }
                }
            }

            currentETag = ETag;
            previousScrollPosition = $(".scrollContainer").scrollTop();
            if (!appendMode) $("#imagesList").empty();

            if (appendMode && images.length == 0)
                imagesCount -= appendCount;
            for (let image of images) {
                insertIntoImageList(image);
            }

            $(".scrollContainer").scrollTop(previousScrollPosition);
            $(".editCmd").off();
            $(".deleteCmd").off();
            $(".showMore").off();
            $(".editCmd").click(e => {
                editimage(e)
            });
            $(".image").click(e => {
                observeimage(e)
            });
            $(".deleteCmd").click(e => {
                deleteimage(e)
            });

            $('[data-toggle="tooltip"]').tooltip();
        }

        function error(status) {
            let errorMessage = "";
            switch (status) {
                case 0:
                    errorMessage = "Le service ne répond pas";
                    break;
                case 401:
                    errorMessage = "Requête non autorisée";
                    break;
                case 400:
                case 422:
                    errorMessage = "Requête invalide";
                    break;
                case 404:
                    errorMessage = "Service ou données introuvables";
                    break;
                case 409:
                    errorMessage = "Conflits de données: Hyperlien existe déjà";
                    break;
                case 500:
                    errorMessage = "Erreur interne du service";
                    break;
                default:
                    errorMessage = "Une erreur est survenue";
                    break;
            }
            $("#errorMessage").text(errorMessage);
            $("#errorDlg").dialog('open');
        }

        function newImage() {
            holdCheckETag = true;
            createMode = true;
            resetimageForm();
            ImageUploader.imageRequired('image', true);
            $("#imageDlg").dialog('option', 'title', "Ajout d'image");
            $("#imageDlgOkBtn").text("Ajouter");
            $("#imageDlg").dialog('open');
        }

        function editimage(e) {
            holdCheckETag = true;
            createMode = false;
            GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
            holdCheckETag = true;
            ImageUploader.imageRequired('image', false);
            $("#imageDlg").dialog('option', 'title', "Modification d'image");
            $("#imageDlgOkBtn").text("Modifier");
            $("#imageDlg").dialog('open');
        }

        function observeimage(e) {
            console.log(e)
            holdCheckETag = true;
            createMode = false;
            GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
            holdCheckETag = true;
            ImageUploader.imageRequired('image', false);
            $("#imageDetailsDlg").dialog('option', 'title', "Détails de l'image");
            $("#imageDetailsDlgOkBtn").text("ok");
            $("#imageDetailsDlg").dialog("open");
        }


        function deleteimage(e) {
            holdCheckETag = true;
            imageIdToDelete = e.target.getAttribute("imageid")
            GET_ID(
                imageIdToDelete,
                image => {
                    $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title +
                        "</b>?")
                },
                error
            );
            holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
            $("#confirmDeleteDlgOkBtn").text("Effacer");
            $("#confirmDeleteDlg").dialog('open');
        }

        function resetimageForm() {
            $("#Id_input").val("0");
            $("#GUID_input").val("");
            $("#date_input").val(Date.now());
            $("#title_input").val("");
            $("#description_input").val("");
            ImageUploader.resetImage('image');
        }

        function imageFromForm() {
            if ($("#imageForm")[0].checkValidity()) {
                let image = {
                    Id: parseInt($("#Id_input").val()),
                    GUID: $("#GUID_input").val(),
                    Title: $("#title_input").val(),
                    Description: $("#description_input").val(),
                    ImageData: ImageUploader.getImageData('image'),
                    Date: parseInt($("#date_input").val())
                };
                return image;
            } else {
                $("#imageForm")[0].reportValidity()
            }
            return false;
        }

        function imageToForm(image) {
            $("#Id_input").val(image.Id);
            $("#GUID_input").val(image.GUID);
            $("#date_input").val(image.Date);
            //$("#date_input").val(Date.now());
            $("#title_input").val(image.Title);
            $("#description_input").val(image.Description);
            ImageUploader.setImage('image', image.OriginalURL);
        }


        function init_UI() {
            $("#newImageCmd").click(newImage);
            if (window.localStorage.length <= 0) {
                $("#email-login").val("");
                $("#pwd-login").val("");
                document.getElementById("checked-user").checked = false;
            } else {
                $("#email-login").val(window.localStorage.getItem("email_login"));
                $("#pwd-login").val(window.localStorage.getItem("pwd_login"));
                document.getElementById("checked-user").checked = true;
            }

            $("#imageDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: {
                    effect: 'fade',
                    speed: 400
                },
                hide: {
                    effect: 'fade',
                    speed: 400
                },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: {
                    my: "top",
                    at: "top",
                    of: window
                },
                buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            if (image) {
                                if (createMode) {
                                    POST(image, getImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                } else
                                    PUT(image, getImagesList, error);
                                resetimageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                ]
            });

            $("#confirmDeleteDlg").dialog({
                title: "Attention!",
                autoOpen: false,
                modal: true,
                show: {
                    effect: 'fade',
                    speed: 400
                },
                hide: {
                    effect: 'fade',
                    speed: 400
                },
                width: 500,
                minWidth: 500,
                maxWidth: 500,
                height: 230,
                minHeight: 230,
                maxHeight: 230,
                position: {
                    my: "top",
                    at: "top",
                    of: window
                },
                buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                DELETE(imageIdToDelete, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }
                ]
            });

            $("#errorDlg").dialog({
                title: "Erreur...",
                autoOpen: false,
                modal: true,
                show: {
                    effect: 'fade',
                    speed: 400
                },
                hide: {
                    effect: 'fade',
                    speed: 400
                },
                width: 500,
                minWidth: 500,
                maxWidth: 500,
                height: 230,
                minHeight: 230,
                maxHeight: 230,
                position: {
                    my: "top",
                    at: "top",
                    of: window
                },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        imageIdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $(".scrollContainer").scroll(function () {
                if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList")
                    .height()) {
                    getImagesList(false);
                }
            });
        }
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //---GAB---//


        $("#message-about").dialog({
            title: "À propos",
            autoOpen: false,
            modal: true,
            show: {
                effect: 'fade',
                speed: 400
            },
            hide: {
                effect: 'fade',
                speed: 400
            },
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            height: 230,
            minHeight: 230,
            maxHeight: 230,
            position: {
                my: "top",
                at: "top",
                of: window
            },
            buttons: [{
                text: "Ok",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        });

        function ShowDialogAbout() {
            $("#message-about").dialog("open");
        }

        $("#icon-site").click(ShowDialogAbout);

        function StoreInfoUser() {

        }
        //Create account utilities
        $("#creation-account-form").dialog({
            title: "Création de compte",
            autoOpen: false,
            modal: true,
            show: {
                effect: 'fade',
                speed: 400
            },
            hide: {
                effect: 'fade',
                speed: 400
            },
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            height: 500,
            minHeight: 230,
            maxHeight: 700,
            position: {
                my: "top",
                at: "top",
                of: window
            },
            buttons: [{
                    id: "confirmCreateAccount",
                    text: "Confirmer",
                    click: function () {
                        let newUser = registerUserFromForm();
                        if (newUser) {
                            $(this).dialog("close");
                            ShowVerfiedCodeDialog();
                            CREATE_USER(newUser, getImagesList, error);
                        }
                        resetInfoCreationForm();
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });

        function ShowCreationUserForm() {
            createMode = true;
            $("#creation-account-form").dialog('option', 'title', "Création d'un usager")
            $("#creation-account-form").dialog("open");
        }

        $("#createAccountCmd").click(ShowCreationUserForm);

        function resetInfoCreationForm() {
            $("#Id_User").val("0");
            $("#username_input").val("");
            $("#email_input").val("");
            $("#pwdUser").val("");
            $("#AvatarGUID_input").val("");
            ImageUploader.resetImage('avatar');
        }

        function registerUserFromForm() {
            if ($("#creation-account-form")[0].checkValidity()) {
                let register = {
                    Id: $("#Id_User").val(),
                    Name: $("#username_input").val(),
                    Email: $("#email_input").val(),
                    Password: $("#pwdUser").val(),
                    AvatarGUID: $("#AvatarGUID_input").val(),
                    ImageData: ImageUploader.getImageData('avatar'),
                };
                return register;
            } else {
                $("#creation-account-form")[0].reportValidity();
            }
            return false;
        }
        $("#verifiedEmailDialog").dialog({
            title: "Vérification de courriel",
            autoOpen: false,
            modal: true,
            show: {
                effect: 'fade',
                speed: 400
            },
            hide: {
                effect: 'fade',
                speed: 400
            },
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            height: 400,
            minHeight: 230,
            maxHeight: 500,
            position: {
                my: "top",
                at: "top",
                of: window
            },
            buttons: [{
                    text: "Valider",
                    click: function () {
                        let codeConfirmation = $("#verifyCodeInput").val();
                        
                        if (codeConfirmation) {
                            if(userData != null)
                            {
                                VERIFY_USER_SECOND_CHANCE(codeConfirmation,checkUserConnected,error);
                                $(".scrollContainer").scrollTop(0);
                                isSignedIn = true;
                            }
                            else{
                                $(this).dialog("close");
                                VERIFY_USER(codeConfirmation, getImagesList, error);
                                $(".scrollContainer").scrollTop(0);
                                isSignedIn = true;
                            }
                            
                        }

                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });

        function ShowVerfiedCodeDialog() {
            $("#verifiedEmailDialog").dialog("open");
        }

        function userInfoToForm(user) { //for edit user
            $("#Id_User").val(user.Id);
            $("#AvatarGUID_input").val(user.AvatarGUID);
            $("#username_input").val(user.Name);
            $("#email_input").val(user.Email);
        }

        function editUser(e) {
            let userInfoProfil = JSON.parse(sessionStorage.getItem("user"));
            let userLogin = JSON.parse(sessionStorage.getItem("access_token"))
            holdCheckETag = true;
            createMode = false;
            $("#username_input").val(userInfoProfil.Name);
            $("#email_input").val(userInfoProfil.Email);
            ImageUploader.setImage('avatar', userInfoProfil.AvatarURL);

            holdCheckETag = true;
            $("#creation-account-form").dialog('option', 'title', "Modification de profil");
            $("#confirmCreateAccount").text("Modifier");
            $("#creation-account-form").dialog("option", "buttons",
                [{
                        id: "deleteUser",
                        text: "Désinscrire",
                        click: function () {
                            $(this).dialog("close");
                            ShowDeleteUserDlg();
                        }
                    },
                    {
                        id: "modifierUserForm",
                        text: "Modifier",
                        click: function () {
                            let user = infoFromEditForm();
                            if (user) {
                                userLogin.Name = $("#username_input").val();

                                PUT_USER(user, checkUserConnected, error);
                                $("#creation-account-form").dialog("close");
                                $("#showUserInfo").text(userLogin.Name);
                                $("#username_input").val(userLogin.Name);
                            }
                        }
                    },
                    {
                        id: "cancelBtn",
                        text: "Annuler",
                        click: function () {
                            $("#creation-account-form").dialog("close");
                            resetInfoCreationForm();
                        }
                    }
                ]);
            $("#creation-account-form").dialog('open');
        }

        function infoFromEditForm() {
            let userInfo = JSON.parse(window.sessionStorage.getItem("user"));
            if ($("#creation-account-form")[0].checkValidity()) {
                let user = {
                    Id: userInfo.Id,
                    Name: $("#username_input").val(),
                    Email: $("#email_input").val(),
                    Password: $("#pwdUser").val(),
                    AvatarGUID: userInfo.AvatarGUID,
                    AvatarURL: userInfo.AvatarURL,
                    ImageData: ImageUploader.getImageData('avatar'),
                };
                return user;
            } else {
                $("#creation-account-form")[0].reportValidity();
            }
            return false;
        }

        $("#editProfilCmd").click((e) => {
            editUser(e);
        });

        function resetInfoLoginUser() {
            $("#email-login").val(null);
            $("#pwd-login").val(null);
            document.getElementById("checked-user").checked = false;

        }

        function rememberUserConnected() {
            let isChecked = false;
            if (document.getElementById("checked-user").checked) {
                isChecked = true;
                window.localStorage.setItem("email_login", $("#email-login").val());
                window.localStorage.setItem("pwd_login", $("#pwd-login").val());
                window.localStorage.setItem("isChecked", isChecked);

                $("#email-login").val(window.localStorage.getItem("email_login"));
                $("#pwd-login").val(window.localStorage.getItem("pwd_login"));
                $("#checked-user").val(window.localStorage.getItem("isChecked"));
            } else {
                isChecked = false;
                window.localStorage.clear();
                document.getElementById("checked-user").checked = false;
                resetInfoLoginUser();
            }
        }

        //Login user utilities
        $("#loginDialog").dialog({
            title: "Connexion",
            autoOpen: false,
            modal: true,
            show: {
                effect: 'fade',
                speed: 400
            },
            hide: {
                effect: 'fade',
                speed: 400
            },
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            height: 400,
            minHeight: 230,
            maxHeight: 500,
            position: {
                my: "top",
                at: "top",
                of: window
            },
            buttons: [{
                    text: "Confirmer",
                    click: function () {
                        let user_info = connexionFromForm();
                        if (user_info) {
                            $(this).dialog("close");
                            LOGIN_USER(user_info, checkUserConnected, error);
                            if (window.localStorage != null) {
                                rememberUserConnected();
                            }
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });

        $("#verifyUserNotDone").click(ShowVerfiedCodeDialog);
        function checkUserConnected(userData) {
            if (userData != null) {

                if (userData.AvatarURL == "" || userData.AvatarURL == null) {
                    $("#avatarUserConnected").attr("src", "images/No_Avatar.png");
                } else {
                    $("#avatarUserConnected").attr("src", userData.AvatarURL);
                }

                if(userData.VerifyCode != "verified")
                {
                    $("#verifyUserNotDone").show();
                    console.log("square does appear");
                }
                else{
                    $("#verifyUserNotDone").hide();
                }

                $("#createAccountCmd").hide()
                $("#logInCmd").hide();
                $("#logOutCmd").show();
                $("#editProfilCmd").show();
                $("#showUserInfo").text(userData.Name);
                $("#avatarUserConnected").show();
            }

        }

        function LogOutUser() {
            window.sessionStorage.removeItem("access_token");
            window.sessionStorage.removeItem("user");
            $("#createAccountCmd").show();
            $("#logInCmd").show();
            $("#logOutCmd").hide();
            $("#editProfilCmd").hide();
            $("#showUserInfo").text("");
            $("#avatarUserConnected").hide();
            $("#verifyUserNotDone").hide();

        }

        $("#logOutCmd").click(() => {
            let userIdToDelete = JSON.parse(sessionStorage.getItem("access_token"));
            LOGOUT_USER(userIdToDelete.UserId, LogOutUser, error);
        });

        function ShowLoginForm() {
            $("#loginDialog").dialog("open");
        }
        $("#logInCmd").click(ShowLoginForm);

        function connexionFromForm() {
            if ($("#loginForm")[0].checkValidity()) {
                let login = {
                    Email: $("#email-login").val(),
                    Password: $("#pwd-login").val()
                };
                return login;
            } else {
                $("#loginForm")[0].reportValidity();
            }
            return false;
        }

        //Delete user

        $("#deleteUserDialog").dialog({
            title: "Attention!",
            autoOpen: false,
            modal: true,
            show: {
                effect: 'fade',
                speed: 400
            },
            hide: {
                effect: 'fade',
                speed: 400
            },
            width: 500,
            minWidth: 500,
            maxWidth: 500,
            height: 250,
            minHeight: 230,
            maxHeight: 400,
            position: {
                my: "top",
                at: "top",
                of: window
            },
            buttons: [{
                    id: "deleteAccountUser",
                    text: "Retirer mon compte",
                    click: function () {
                        let user = JSON.parse(sessionStorage.getItem("user"));
                        DELETE_USER_ACCOUNT(user.Id, LogOutUser, error);
                        $(this).dialog("close");
                        window.location.reload();

                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        $(this).dialog("close");
                    }
                }
            ]
        });

        function ShowDeleteUserDlg() {
            $("#deleteUserDialog").dialog("open");
        }



        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    </script>

</body>

</html>